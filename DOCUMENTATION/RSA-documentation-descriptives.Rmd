---
title: "Rating Scale Analysis"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

### Descriptives

This script generates these output files:

* Tables (.csv)
  * `freq-item-val`: item response counts
  * `freq-demos`: case counts for age range, gender, (parent) education, ethnicity, region, clinical status
  * `raw-desc`: scale raw score means, SDs

* Plots (.pdf)
  * `freq-demos`(histogram)
  * `raw-desc` (scatterplot)

The code can handle a set of input files that represent different forms (e.g., different combinations of age-range and rater). The output files are labeled analogously with `[age-range]-[rater]` nomenclature (e.g., `child-parent`, `teen-teacher`, etc.)

#### 1. Load packages, read data, specify input parameters

###### EXECUTABLE CODE
```{r descriptives-load, eval = FALSE}
suppressMessages(library(here))
suppressMessages(suppressWarnings(library(tidyverse)))
suppressMessages(library(psych))
library(ggrepel)
library(ggpubr)

urlRemote_path  <- "https://raw.githubusercontent.com/"
github_path <- "DSHerzberg/RATING-SCALE-ANALYSIS/master/INPUT-FILES/"

data_RS_sim_child_parent <- suppressMessages(read_csv(url(
  str_c(urlRemote_path, github_path, "data-RS-sim-child-parent.csv")
)))
data_RS_sim_child_teacher <- suppressMessages(read_csv(url(
  str_c(urlRemote_path, github_path, "data-RS-sim-child-teacher.csv")
)))
data_RS_sim_teen_parent <- suppressMessages(read_csv(url(
  str_c(urlRemote_path, github_path, "data-RS-sim-teen-parent.csv")
)))
data_RS_sim_teen_teacher <- suppressMessages(read_csv(url(
  str_c(urlRemote_path, github_path, "data-RS-sim-teen-teacher.csv")
)))

data_name_suffix <- c("child_parent", "child_teacher", "teen_parent", "teen_teacher")
item_col_prefix <- c("cp", "ct", "tp", "tt")
scale_col_prefix <- toupper(item_col_prefix)
var_order <- c("age_range", "gender", "educ", "ethnic", "region", "clin_status")
cat_order <- c(
  "5 to 8 yo", "9 to 12 yo", "13 to 15 yo", 
  "16 to 18 yo",
  "male", "female",
  "no_HS","HS_grad", "some_college", "BA_plus", 
  "hispanic","asian", "black", "white", "other", 
  "northeast","south", "midwest", "west",
  "typ", "clin", 
  "never", "occasionally","frequently", "always"
)

item_cols <- item_col_prefix %>% 
  map(
    ~ str_c(.x, "i", str_pad(as.character(1:50), 2, side = "left", pad = "0"))
  ) %>% 
  set_names(str_c("item_cols_", data_name_suffix))
    
item_cats <- replicate(
  4, 
  c("never", "occasionally","frequently", "always"), 
  simplify =  F
  )  %>% 
  set_names(str_c("item_cats_", data_name_suffix))
```

###### COMMENTED SNIPPETS
Load packages for file path specification (`here`), data wrangling (`tidyverse`) psychometric data simulation and analysis (`psych`), plot labeling (`ggrepel`), and formatting plots for export as .pdf (`ggpubr`).
```{r descriptives-load, echo = 1:5, eval = F}
```
Specify file paths and retrieve data from a remote host. The script reads in four input files consisting of simulated rating-scale (`RS`) data:

* `data-RS-sim-child-parent.csv`: `child` age range (5-12 yo), `parent` report
* `data-RS-sim-child-teacher`: `child` age range (5-12 yo), `teacher` report
* `data-RS-sim-teen-parent.csv`: `teen` age range (13-18 yo), `parent` report
* `data-RS-sim-teen-teacher.csv`: `teen` age range (13-18 yo), `teacher` report

```{r descriptives-load, echo = 7:21, eval = F}
```
Initialize vectors containing file, variable, and category names, abbrievations, and pre/suffixes. These vectors will be used throughout the script.
```{r descriptives-load, echo = 23:36, eval = F}
```
Initialize a list containing four character vectors whose elements are the item column names for the four input data files. We use `purrr::map()` to iterate over the vector containing the item column prefixes (`item_col_prefix`). We apply a lambda (anonymous) function with `~` to create item column names with an `i01` to `i50` nomenclature. `stringr::str_pad()` pads a numerical sequence with zeros to the left of each number. Note the use of `base::as_character()` to coerce the number sequence `1:50` to a sequence of strings. This is wrapped in `stringr::str_c()` which concatenates the prefixes in `item_col_prefix` with the zero-padded numbers. We then use `purrr::set_names()` to name the vectors within the list, again employing `str_c()` to iteratively concatenate a prefix `"item_cols_"` with a vector of suffixes `data_name_suffix`.
```{r descriptives-load, echo = 38:42, eval = F}
```
We use `base::replicate()` to return a list (`item_cats`) containing four identical vectors whose elements are the item rating categories `c("never", "occasionally","frequently", "always")`. We use `set_names()` to name the vectors correspondingly to the input data files.
```{r descriptives-load, echo = 44:49, eval = F}
```

#### 2. Item Response Frequencies

The item response frequency tables provide counts of responses across the four categories for each item. The script generates a separate table for each input data file. These frequency tables are named with the prefix `freq_item_val` and saved to `.csv` in the `OUTPUT-FILES/TABLES` folder.

###### EXECUTABLE CODE
```{r descriptives-freq-item-val, eval = FALSE}
list(mget(str_c("data_RS_sim_", data_name_suffix)),
     item_cols,
     item_cats,
     data_name_suffix) %>%
  pmap(
    ~ ..1 %>%
      select(!!..2) %>%
      pivot_longer(everything(), names_to = 'item', values_to = 'value') %>%
      count(item, value) %>%
      pivot_wider(names_from = value, values_from = n) %>%
      arrange(match(item, !!..2)) %>%
      mutate(data = case_when(rownames(.) == "1" ~ ..4,
                              T ~ NA_character_)) %>%
      select(data, item, !!..3)
  ) %>%
  set_names(str_c("freq_item_val_", data_name_suffix)) %>%
  list2env(envir = .GlobalEnv)

iwalk(mget(str_c("freq_item_val_", data_name_suffix)),
      ~ write_csv(.x, here(
        str_c("OUTPUT-FILES/TABLES/",
              str_replace_all(.y, "_", "-"),
              ".csv")
      ),
      na = ""))
```

###### COMMENTED SNIPPETS
We first initialize a `list` containing the objects required to assemble the tables. We use `base::mget()` to bring the four input data files into the list. Here `mget()` returns the objects named by the character vector `str_c("data_RS_sim_", data_name_suffix)`, whose elements are the names of the four input files. Also included in this list are the `item_cols`, `item_cats`, and `data_name_suffix` vectors.
```{r descriptives-freq-item-val, echo = 1:4, eval = F}
```
We use `purrr::pmap()` to iterate simultaneously over several inputs of equal length (here all inputs have length of four). We apply a function, designated by `~`, to these inputs in parallel. Within the body of the funtion, we refer to the inputs using a numerical shorthand. Here, `..1` refers to the first input object, the list containing the four input data files. `..2` refers to the second input object (`item_cols`), a list containing vectors of item column names for each of the four input data files. Because these names are strings, we need to unquote them, using the `!!` operator, in order to pass them to `select()`. The data object at this point is a list, with each element a data frame containing only the item columns from the input data files.
```{r descriptives-freq-item-val, echo = 5:7, eval = F}
```

```{r eval = F}
The data object is a list whose elements are data frames (shown here is the upper left corner of one).

  cpi01  cpi02  cpi03 cpi04 cpi05 cpi06 cpi07 cpi08 cpi09 cpi10 cpi11 cpi12 cpi13 cpi14 cpi15 cpi16 cpi17

1 never  never  occa… never occa… freq… occa… freq… occa… never occa… freq… never freq… freq… freq… alwa…
2 never  frequ… freq… alwa… occa… occa… occa… freq… occa… occa… occa… never never never occa… never occa…
3 never  never  never never never never never never occa… never occa… never never occa… freq… never never
4 occas… occas… occa… occa… occa… freq… never occa… occa… freq… alwa… occa… occa… alwa… occa… freq… never
5 never  never  never never never never occa… freq… never never never alwa… alwa… occa… never occa… occa…
6 never  never  never never never occa… occa… never never never never never occa… never occa… occa… never
```



We use `tidyr::pivot_longer()` to transform the data object from wide to long (nested) format. The arguments to `pivot_longer()` include the `tidyselect` helper `everything()`, which indicates that all columns will be included in the transformation, and the names of the new destination columns for the input column names (`names_to`) and the input cell values (`values_to`). `pivot_longer` returns a nested data frame with two columns, `item` and `value`. In this long object, the items and their respective response values are nested within each case of the input, running down the rows for the case and then repeating the same items for the next case, and so on.

We then use `dplyr::count()` to summarize this object. Passing `item` and `value` as arguments groups the summary object by these two variables, such that a new column `n` provides the case count for each pairing of item and response value (i.e., the first row is the number of cases that responded `always` to item `cpi01`, the second row is the number of cases that responded `frequently` to item `cpi01`, and so on). Because the input data file has 50 items, each with four possible response options, the summary object has 200 rows.
```{r descriptives-freq-item-val, echo = 8:9, eval = F}
```
We now transform the summary object back to wide format using `tidyr::pivot_wider()`, the mirror-image function of `pivot_longer()`. The `names_from` and `values_from` arguments indicate that the transformed object will draw its column names from the `value` column and its cell values from the `n` column, respectively, of the input object.
```{r descriptives-freq-item-val, echo = 10, eval = F}
```

####    START HERE: CONTINUE USING SCRATCH CODE TO UNPACK PIPED OBJECT OUT OF pmap()


#### 3. Demographic Frequency Counts

###### EXECUTABLE CODE
```{r descriptives-freq-demos, eval = FALSE}
list(mget(str_c("data_RS_sim_", data_name_suffix)),
     data_name_suffix) %>%
  pmap(
    ~ ..1 %>%
      select(all_of(var_order)) %>%
      pivot_longer(everything(), names_to = 'var', values_to = 'cat') %>%
      count(var, cat) %>%
      arrange(match(var, var_order), match(cat, cat_order)) %>%
      mutate(
        var = case_when(
          lag(var) == "age_range" & var == "age_range" ~ NA_character_,
          lag(var) == "gender" & var == "gender" ~ NA_character_,
          lag(var) == "educ" & var == "educ" ~ NA_character_,
          lag(var) == "ethnic" & var == "ethnic" ~ NA_character_,
          lag(var) == "region" & var == "region" ~ NA_character_,
          lag(var) == "clin_status" & var == "clin_status" ~ NA_character_,
          TRUE ~ var
        ),
        data = case_when(rownames(.) == "1" ~ ..2,
                         T ~ NA_character_)
        # data = ..2
      ) %>%
      select(data, var, cat, n)
  ) %>%
  set_names(str_c("freq_demos_", data_name_suffix)) %>%
  list2env(envir = .GlobalEnv)

iwalk(mget(str_c("freq_demos_", data_name_suffix)),
      ~ write_csv(.x, here(
        str_c("OUTPUT-FILES/TABLES/",
              str_replace_all(.y, "_", "-"),
              ".csv")
      ),
      na = ""))

map(mget(str_c("freq_demos_", data_name_suffix)), ~ .x %>% 
   fill(c(data, var))) %>%
    list2env(envir = .GlobalEnv)

hist_list <- lst(
  freq_demos_child_parent,
  freq_demos_child_teacher,
  freq_demos_teen_parent,
  freq_demos_teen_teacher
) %>%
  map( ~
         tibble(var = map(var_order, ~ .y %>% filter(var == .x), .y = .x))) %>%
  tibble(file = names(.), data1 = .) %>%
  unnest(cols = c(data1)) %>%
  mutate(plots = map2(
    var,
    file,
    ~
      print(
        ggplot(data = .x, aes(cat, n)) +
          geom_col(col = "red",
                   fill = "blue",
                   alpha = .2,
                   width = .3) +
          scale_y_continuous(breaks = seq(0, max(.x$n), 50)) +
          labs(subtitle = str_c(
            "Demo Counts - ",
            str_replace(str_sub(.y
                                , 12), "_", " form, "),
            " report"
          )) +
          scale_x_discrete(limits = .x %>% pull(cat)) +
          theme(panel.grid.minor = element_blank(),
                axis.title.x = element_blank()) +
          facet_wrap(vars(var))
      )
  ))

hist_plot_prep <- map(
  map(unique(hist_list$file), ~ hist_list %>% filter(file == .x)), 
  ~ ggpubr::ggarrange(plotlist = .x$plots, ncol = 2, nrow = 2))

walk2(hist_plot_prep,
      unique(hist_list$file),
      ~ ggpubr::ggexport(.x, filename = here(
        str_c("OUTPUT-FILES/PLOTS/", str_replace_all(.y, "_", "-"),
              ".pdf")
      )))
```

#### 4. Raw Score Descriptive Statistics

###### EXECUTABLE CODE
```{r descriptives-raw-desc, eval = FALSE}
list(mget(str_c("data_RS_sim_", data_name_suffix)),
     data_name_suffix) %>%
  pmap(
    ~ ..1 %>%
      select(contains('raw')) %>%
      describe(fast = T) %>%
      rownames_to_column() %>%
      rename(scale = rowname) %>%
      mutate(
        data = case_when(rownames(.) == "1" ~ ..2,
                         T ~ NA_character_),
        # data = ..2,
        across(c(mean, sd),
               ~ round(., 2))
      ) %>%
      select(data, scale, n, mean, sd)
  ) %>%
  set_names(str_c("raw_desc_", data_name_suffix)) %>%
  list2env(envir = .GlobalEnv)

iwalk(mget(str_c("raw_desc_", data_name_suffix)),
      ~ write_csv(.x, here(
        str_c("OUTPUT-FILES/TABLES/",
              str_replace_all(.y, "_", "-"),
              ".csv")
      ),
      na = ""))

map(mget(str_c("raw_desc_", data_name_suffix)), ~ .x %>% 
      fill(data)) %>%
  list2env(envir = .GlobalEnv)

imap(
  .x = lst(
    raw_desc_child_parent,
    raw_desc_child_teacher,
    raw_desc_teen_parent,
    raw_desc_teen_teacher
  ),
  ~ print(
    ggplot(.x, aes(scale, mean)) +
      geom_point(
        col = "blue",
        fill = "blue",
        alpha = .5,
        size = 3,
        shape = 23
      ) +
      geom_label_repel(
        aes(label = mean),
        hjust = .7,
        vjust = -1,
        label.padding = unit(0.1, "lines"),
        size = 4,
        col = "blue"
      ) +
      scale_y_continuous(breaks = seq(0, 15, by = 1), limits = c(0, 15)) +
      labs(
        title = str_c(
          "Raw Score Means (with SDs) - ",
          str_replace(str_sub(.y, 10), "_", " form, "),
          " report"
        ),
        x = "Scale",
        y = "Raw Score Mean"
      ) +
      geom_errorbar(
        aes(ymin = mean - sd, ymax = mean + sd),
        col = "red",
        size = 0.2,
        width = 0.2
      )
  )
) %>%
  iwalk(~ ggsave(plot = .x, file = here(
    str_c("OUTPUT-FILES/PLOTS/",
          str_replace_all(.y, "_", "-"), ".pdf")
  )))
```
