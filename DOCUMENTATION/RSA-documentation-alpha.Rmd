---
title: "Rating Scale Analysis"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

### Internal Consistency (coefficient alpha)

This code can handle a set of input files that represent different forms (e.g., different combinations of age-range and rater). It generates a single .csv output file summarizing internal consistency analysis across all forms. The output table is formatted as in this example: 

```{eval = F}
   form      n scale alpha   SEM CI_90    CI_95   
 1 CP     1000 S1     0.08  2.72 6 -- 15  5 -- 16 
 2             S2     0.12  2.73 6 -- 15  5 -- 16 
 3             S3     0.04  2.73 6 -- 15  5 -- 15 
 4             S4     0.03  2.75 6 -- 15  5 -- 16 
 5             S5     0     2.76 6 -- 15  5 -- 16 
 6             TOT    0.52  6.13 41 -- 61 39 -- 63
 7 CT     1000 S1     0.03  2.75 6 -- 15  5 -- 16 
 8             S2     0.08  2.75 6 -- 15  5 -- 16 
 9             S3     0.07  2.73 6 -- 15  5 -- 16 
10             S4     0.04  2.76 6 -- 15  5 -- 16 
```

Where `CI_90` and `CI_95` are the 90% and 95% confidence intervals, respectively. Note that alpha values are unexpectedly low, due to the use of simulated (as opposed to human-generated) data.

#### 1. Load packages, read data, specify input parameters

###### EXECUTABLE CODE
```{r alpha-load, eval = FALSE}
suppressPackageStartupMessages(library(here))
suppressMessages(suppressWarnings(library(tidyverse)))
suppressMessages(library(psych))

urlRemote_path  <- "https://raw.githubusercontent.com/"
github_path <- "DSHerzberg/RATING-SCALE-ANALYSIS/master/INPUT-FILES/"

data_RS_sim_child_parent <- suppressMessages(read_csv(url(
  str_c(urlRemote_path, github_path, "data-RS-sim-child-parent.csv")
)))
data_RS_sim_child_teacher <- suppressMessages(read_csv(url(
  str_c(urlRemote_path, github_path, "data-RS-sim-child-teacher.csv")
)))
data_RS_sim_teen_parent <- suppressMessages(read_csv(url(
  str_c(urlRemote_path, github_path, "data-RS-sim-teen-parent.csv")
)))
data_RS_sim_teen_teacher <- suppressMessages(read_csv(url(
  str_c(urlRemote_path, github_path, "data-RS-sim-teen-teacher.csv")
)))

form_acronyms <- c("cp", "ct", "tp", "tt")

scale_items_suffix <- c("S1", "S2", "S3", "S4", "S5", "TOT")

form_scale_cols <-
  crossing(str_to_upper(form_acronyms), scale_items_suffix) %>%
  set_names(c("form", "scale")) 

input_recode_list <- map(
  lst(
    data_RS_sim_child_parent,
    data_RS_sim_child_teacher,
    data_RS_sim_teen_parent,
    data_RS_sim_teen_teacher
  ),
  ~
    .x %>%
    mutate(
      across(
        contains("cpi") |
          contains("cti") | contains("tpi") | contains("tti"),
        ~ case_when(
          .x == "never" ~ 1,
          .x == "occasionally" ~ 2,
          .x == "frequently" ~ 3,
          .x == "always" ~ 4
        )
      )
    )
)
```

###### COMMENTED SNIPPETS
Load packages for file path specification (`here`), data wrangling (`tidyverse`), and psychometric data simulation and analysis (`psych`).
```{r alpha-load, echo = 1:3, eval = F}
```
Specify file paths and retrieve data from a remote host. The script reads in four input files consisting of simulated rating-scale (`RS`) data:

* `data-RS-sim-child-parent.csv`: `child` age range (5-12 yo), `parent` report
* `data-RS-sim-child-teacher`: `child` age range (5-12 yo), `teacher` report
* `data-RS-sim-teen-parent.csv`: `teen` age range (13-18 yo), `parent` report
* `data-RS-sim-teen-teacher.csv`: `teen` age range (13-18 yo), `teacher` report

```{r alpha-load, echo = 5:19, eval = F}
```
Initialize containers for form and scale abbreviations, to be used elsewhere in the script.

`form_scale_cols` is a 24-row data frame holding the `form` and `scale` columns of the final output table. It is assembled with `tidyr::crossing()` which takes the two character vectors `form_acronyms` and `scale_items_suffix` as its arguments. `crossing()` creates a data frame with the two input vectors as columns, expanding each vector so that all possible combinations of the vector elements are represented. This provides the required structure for the output table, where each `form` has an identical set of six `scale` rows. We wrap `form_acronyms` in `stringr::str_to_upper()` to change the case of the form acronyms.
```{r alpha-load, echo = 21:27, eval = F}
```
To conduct the analysis, we need to recode the item responses to numeric variables. We put the four input data frames into a list, using `tibble::lst()`, which retains the input object names as list element names. We then `map()` an anonymous recoding function over this list. `case_when()` specifies the logic for recoding the input strings into numbers (e.g., if the input cell value is `"never"`, the recode output is `1`). `across()` specifies the subset of columns that will be recoded. `contains()` is a `tidyselect` helper that captures columns whose names contain a certain substring (e.g., `"cpi`, the acronym for child-parent items). 

To account for the four different item name prefixes in the four input files, we pass a four-element predicate as the first argument to `across()`, in which we use the `|` operator to denote a disjunctive set. That is, if _any_ of the four item name prefixes is present in the current iteration of the input data set, `across()` will capture and recode all the columns whose names contain that prefix. The mapping operation returns a four-element list containing the four input data frames, with all item responses recoded to numeric.
```{r alpha-load, echo = 29:50, eval = F}
```

